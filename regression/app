#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json
from pathlib import Path

import numpy as np

from hhreg.io import load_model


def main() -> int:
    parser = argparse.ArgumentParser(
        prog="app",
        description="Predict salaries from x_data.npy using pretrained model in resources/",
    )
    parser.add_argument("x_path", type=str, help="Path to x_data.npy")
    args = parser.parse_args()

    x_path = Path(args.x_path).expanduser().resolve()
    if not x_path.exists():
        raise FileNotFoundError(f"x_data.npy not found: {x_path}")

    repo_dir = Path(__file__).resolve().parent
    model_path = repo_dir / "resources" / "model.npz"
    if not model_path.exists():
        raise FileNotFoundError(
            f"Model weights not found: {model_path}\n"
            f"Train first: python -m hhreg.train path/to/x_data.npy path/to/y_data.npy"
        )

    x = np.load(x_path).astype(np.float32, copy=False)
    model = load_model(model_path)

    preds = model.predict(x).astype(float)
    preds = np.clip(preds, 0, None)
    print(json.dumps(preds.tolist(), ensure_ascii=False))

    return 0


if __name__ == "__main__":
    raise SystemExit(main())
